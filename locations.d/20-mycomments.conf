# =============================================================================
# 20-mycomments.conf - Comment Section Web App
# =============================================================================
# Serves at: /mycomments
# Backend: comment-backend-api:3000, comment-moderation-service:3001
# =============================================================================

# Redirect /mycomments to /mycomments/
location = /mycomments {
    return 301 /mycomments/;
}

# MyComments index page (exact match for trailing slash)
location = /mycomments/ {
    limit_req off;

    alias /usr/share/nginx/html/mycomments/;
    index index.html;
    try_files /index.html =404;
    add_header Cache-Control "no-cache, no-store, must-revalidate";

    # Allow embedding in iframes (for external sites)
    add_header X-Frame-Options "" always;
    add_header Content-Security-Policy "frame-ancestors *" always;
}

# MyComments embed.js (served from root for backwards compatibility during transition)
location = /embed.js {
    limit_req off;
    alias /usr/share/nginx/html/mycomments/embed.js;
    add_header Cache-Control "no-cache";
    add_header Content-Type "application/javascript";
    add_header Access-Control-Allow-Origin "*";
}

# MyComments embed.js at new path
location = /mycomments/embed.js {
    limit_req off;
    alias /usr/share/nginx/html/mycomments/embed.js;
    add_header Cache-Control "no-cache";
    add_header Content-Type "application/javascript";
    add_header Access-Control-Allow-Origin "*";
}

# MyComments auth endpoint - Discord callback (stricter rate limiting)
# Exact match locations take priority over ^~ prefix locations
location = /mycomments/api/discord/callback {
    limit_req zone=auth burst=5 nodelay;

    set $backend_upstream http://comment-backend-api:3000;
    proxy_pass $backend_upstream/api/discord/callback;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
}

# MyComments auth endpoint - Logout (stricter rate limiting)
location = /mycomments/api/logout {
    limit_req zone=auth burst=5 nodelay;

    set $backend_upstream http://comment-backend-api:3000;
    proxy_pass $backend_upstream/api/logout;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
}

# MyComments Service Worker (exact match for correct headers)
location = /mycomments/sw.js {
    limit_req off;
    alias /usr/share/nginx/html/mycomments/sw.js;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Content-Type "application/javascript";
}

# MyComments theme.css (dynamic from backend)
location = /mycomments/theme.css {
    limit_req off;
    set $backend_upstream http://comment-backend-api:3000;
    proxy_pass $backend_upstream/theme.css;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    add_header Cache-Control "no-cache";
}

# MyComments API proxy (general)
# ^~ prevents regex locations from matching /mycomments/api/ paths
location ^~ /mycomments/api/ {
    limit_req zone=api burst=50 nodelay;

    set $backend_upstream http://comment-backend-api:3000;
    rewrite ^/mycomments/api/(.*) /api/$1 break;
    proxy_pass $backend_upstream;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Prefix /mycomments;
    proxy_cache_bypass $http_upgrade;

    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}

# MyComments moderation API proxy
location ^~ /mycomments/moderation/ {
    limit_req zone=api burst=20 nodelay;

    set $moderation_upstream http://comment-moderation-service:3001;
    rewrite ^/mycomments/moderation/(.*) /$1 break;
    proxy_pass $moderation_upstream;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
}

# MyComments static frontend files (catch-all for /mycomments/)
# This handles all static files: JS, CSS, HTML, images, etc.
location ^~ /mycomments/ {
    # Disable rate limiting for static files
    limit_req off;

    alias /usr/share/nginx/html/mycomments/;
    try_files $uri $uri/ @mycomments_fallback;

    # No aggressive caching - let browser handle with ETags
    add_header Cache-Control "no-cache, no-store, must-revalidate";

    # Allow embedding in iframes
    add_header X-Frame-Options "" always;
    add_header Content-Security-Policy "frame-ancestors *" always;
}

# MyComments SPA fallback (for client-side routing)
location @mycomments_fallback {
    limit_req off;
    root /usr/share/nginx/html;
    try_files /mycomments/index.html =404;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header X-Frame-Options "" always;
    add_header Content-Security-Policy "frame-ancestors *" always;
}
