# =============================================================================
# 40-bpd.conf - Behavioral Pattern Discovery
# =============================================================================
# Serves at: /bpd
# Backend: bpd-api:8000 (FastAPI)
# Frontend: Static files
# =============================================================================

# BPD root - redirect /bpd to /bpd/
location = /bpd {
    return 301 /bpd/;
}

# BPD index page
location = /bpd/ {
    alias /usr/share/nginx/html/bpd/;
    index index.html;
    try_files /index.html =404;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
}

# BPD Static frontend files
location ^~ /bpd/ {
    alias /usr/share/nginx/html/bpd/;
    try_files $uri $uri/ @bpd_fallback;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
}

# BPD SPA fallback
location @bpd_fallback {
    root /usr/share/nginx/html;
    try_files /bpd/index.html =404;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
}

# BPD API proxy
location ^~ /bpd/api/ {
    limit_req zone=api burst=50 nodelay;

    set $bpd_upstream http://bpd-api:8000;
    rewrite ^/bpd/api/(.*) /api/$1 break;
    proxy_pass $bpd_upstream;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Prefix /bpd;

    # Larger body size for file uploads
    client_max_body_size 500m;

    # Longer timeouts for training operations
    proxy_connect_timeout 60s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;
}

# BPD Internal API (for Modal callbacks)
location ^~ /bpd/internal/ {
    set $bpd_upstream http://bpd-api:8000;
    rewrite ^/bpd/internal/(.*) /internal/$1 break;
    proxy_pass $bpd_upstream;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;

    # Large body for checkpoint uploads
    client_max_body_size 500m;

    # Long timeout for large file transfers
    proxy_connect_timeout 60s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;
}

# BPD External API
location ^~ /bpd/external/ {
    limit_req zone=api burst=30 nodelay;

    set $bpd_upstream http://bpd-api:8000;
    rewrite ^/bpd/external/(.*) /external/$1 break;
    proxy_pass $bpd_upstream;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
}

# BPD WebSocket
location ^~ /bpd/ws/ {
    set $bpd_upstream http://bpd-api:8000;
    rewrite ^/bpd/ws/(.*) /ws/$1 break;
    proxy_pass $bpd_upstream;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;

    # Critical for WebSocket: disable buffering so messages are sent immediately
    proxy_buffering off;

    # WebSocket timeout (24 hours)
    proxy_read_timeout 86400s;
}

# BPD Health check
location = /bpd/health {
    set $bpd_upstream http://bpd-api:8000;
    proxy_pass $bpd_upstream/health;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
}
