# =============================================================================
# 20-comments.conf - Comment Section Web App
# =============================================================================
# Serves at: /comments
# Backend: comment-backend-api:3000, comment-moderation-service:3001
# =============================================================================

# Redirect /comments to /comments/
location = /comments {
    return 301 /comments/;
}

# Comments index page (exact match for trailing slash)
location = /comments/ {
    alias /usr/share/nginx/html/comments/;
    index index.html;
    try_files /index.html =404;
    add_header Cache-Control "no-cache, no-store, must-revalidate";

    # Allow embedding in iframes (for external sites)
    add_header X-Frame-Options "" always;
    add_header Content-Security-Policy "frame-ancestors *" always;
}

# Comments embed.js (served from root for backwards compatibility during transition)
location = /embed.js {
    alias /usr/share/nginx/html/comments/embed.js;
    add_header Cache-Control "no-cache";
    add_header Content-Type "application/javascript";
    add_header Access-Control-Allow-Origin "*";
}

# Comments embed.js at new path
location = /comments/embed.js {
    alias /usr/share/nginx/html/comments/embed.js;
    add_header Cache-Control "no-cache";
    add_header Content-Type "application/javascript";
    add_header Access-Control-Allow-Origin "*";
}

# Comments auth endpoint - Discord callback (stricter rate limiting)
# Exact match locations take priority over ^~ prefix locations
location = /comments/api/discord/callback {
    limit_req zone=auth burst=5 nodelay;

    set $backend_upstream http://comment-backend-api:3000;
    proxy_pass $backend_upstream/api/discord/callback;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
}

# Comments auth endpoint - Logout (stricter rate limiting)
location = /comments/api/logout {
    limit_req zone=auth burst=5 nodelay;

    set $backend_upstream http://comment-backend-api:3000;
    proxy_pass $backend_upstream/api/logout;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
}

# Comments Service Worker (exact match for correct headers)
location = /comments/sw.js {
    alias /usr/share/nginx/html/comments/sw.js;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Content-Type "application/javascript";
}

# Comments theme.css (dynamic from backend)
location = /comments/theme.css {
    set $backend_upstream http://comment-backend-api:3000;
    proxy_pass $backend_upstream/theme.css;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    add_header Cache-Control "no-cache";
}

# Comments API proxy (general)
# ^~ prevents regex locations from matching /comments/api/ paths
location ^~ /comments/api/ {
    limit_req zone=api burst=50 nodelay;

    set $backend_upstream http://comment-backend-api:3000;
    rewrite ^/comments/api/(.*) /api/$1 break;
    proxy_pass $backend_upstream;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Prefix /comments;
    proxy_cache_bypass $http_upgrade;

    proxy_connect_timeout 60s;
    proxy_send_timeout 60s;
    proxy_read_timeout 60s;
}

# Comments moderation API proxy
location ^~ /comments/moderation/ {
    limit_req zone=api burst=20 nodelay;

    set $moderation_upstream http://comment-moderation-service:3001;
    rewrite ^/comments/moderation/(.*) /$1 break;
    proxy_pass $moderation_upstream;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
}

# Comments static frontend files (catch-all for /comments/)
# This handles all static files: JS, CSS, HTML, images, etc.
location ^~ /comments/ {
    alias /usr/share/nginx/html/comments/;
    try_files $uri $uri/ @comments_fallback;

    # No aggressive caching - let browser handle with ETags
    add_header Cache-Control "no-cache, no-store, must-revalidate";

    # Allow embedding in iframes
    add_header X-Frame-Options "" always;
    add_header Content-Security-Policy "frame-ancestors *" always;
}

# Comments SPA fallback (for client-side routing)
location @comments_fallback {
    root /usr/share/nginx/html;
    try_files /comments/index.html =404;
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header X-Frame-Options "" always;
    add_header Content-Security-Policy "frame-ancestors *" always;
}
